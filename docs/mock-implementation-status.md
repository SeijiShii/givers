# モック実装 検討・実装状況

**目的**: サーバー実装を凍結し、フロントエンドモックで UX を検討する。本ドキュメントはモックで検討・実装している内容を文書化する。

**最終更新**: 2025-02

---

## 1. モックモードの概要

| 項目 | 内容 |
|------|------|
| **切り替え** | `frontend/.env` の `PUBLIC_MOCK_MODE=true` で有効 |
| **実装場所** | `frontend/src/lib/mock-api.ts` |
| **API 抽象化** | `frontend/src/lib/api.ts` で MOCK_MODE 時に mock-api を呼び出し |
| **起動** | `npm run dev` でサーバーなしで全ページ動作 |

---

## 2. モックデータ

### 2.1 プロジェクト（6件）

| ID | 名前 | 達成率 | 備考 |
|----|------|--------|------|
| mock-1 | オープンソースの軽量エディタ | 84% | |
| mock-2 | 無料の日本語学習アプリ | 119% | 超達成 |
| mock-3 | アクセシビリティチェックツール | 27% | 危険 |
| **mock-4** | **GIVErS プラットフォーム** | **52%** | **プラットフォームプロジェクト（ホスト用）** |
| mock-5 | 子ども向けプログラミング教材 | 50% | 境界 |
| mock-6 | 翻訳ボランティア支援サイト | 88% | |

**データソース**: `frontend/src/data/mock-projects.ts`

### 2.2 定数

| 定数 | 値 | 用途 |
|------|-----|------|
| `PLATFORM_PROJECT_ID` | `mock-4` | プラットフォーム（GIVErS への寄付）プロジェクトの識別 |

**定義場所**: `frontend/src/lib/api.ts`

### 2.3 寄付・定期寄付（マイページ用）

- **寄付履歴**: `frontend/src/data/mock-donations.ts` の `MOCK_DONATIONS`（ユーザー別）
- **定期寄付**: `MOCK_RECURRING_DONATIONS`（ユーザー別、キャンセルはセッション内で反映）

### 2.4 その他モックデータ

- **オーナー名**: `frontend/src/data/mock-activities.ts` の `MOCK_OWNERS`
- **最近の応援者**: `MOCK_RECENT_SUPPORTERS`
- **アクティビティフィード**: `MOCK_ACTIVITIES`
- **チャートデータ**: `frontend/src/data/mock-chart-data.ts`

---

## 3. 実装済み機能

### 3.1 P0（基盤）

| 項目 | 実装 |
|------|------|
| API モック層 | `mock-api.ts` |
| モックプロジェクト | 6件、達成率 27%〜119% |
| トップ新着/HOT | `FeaturedProjects` |
| プロジェクト一覧 | `ProjectList` |

### 3.2 P1（軽量SNS要素）

| 項目 | 実装 |
|------|------|
| アクティビティフィード | `ActivityFeed`（登録・寄付・マイルストーン） |
| オーナー表示 | カード・詳細に「by オーナー名」 |
| 感謝表示 | プロジェクト詳細に「最近の応援者」 |
| 寄付フォーム | `DonateForm`（単発/毎月、¥300〜¥5,000 + 任意額） |

### 3.3 P2（チャート）

| 項目 | 実装 |
|------|------|
| プロジェクトチャート | `ProjectChart`（Recharts、折れ線） |
| 系列 | 最低金額・目標金額・達成額 |
| モックデータ | `mock-chart-data.ts`（直近6ヶ月） |

### 3.4 ホスト・プラットフォームプロジェクト

| 項目 | 実装 |
|------|------|
| **GIVErS への寄付 専用ページ** | `/host`, `/en/host` |
| **プロジェクト一覧での表示** | mock-4 に「プラットフォームプロジェクト」バッジ |
| **双方向リンク** | 専用ページ ⇔ プロジェクト詳細 ⇔ プロジェクト一覧 |
| **運営状況シグナル** | 健全/注意/危険のカード表示 |
| **モックログイン** | ホスト / 寄付メンバー / プロジェクトオーナー 切り替えスイッチ（アプリバー） |
| **ユーザー管理** | `/admin/users`、ホスト時のみユーザー一覧表示 |

### 3.5 マイページ（メンバーページ）

| 項目 | 実装 |
|------|------|
| **タブ切り替え** | 寄付タブ / プロジェクトタブ |
| **寄付タブ** | 寄付履歴一覧、定期寄付管理（変更・一時休止/再開・削除） |
| **プロジェクトタブ** | 新規作成リンク、編集リンク、ステータス変更（active / frozen / deleted） |
| **モックデータ** | `mock-donations.ts`（寄付履歴・定期寄付）、`getMyProjects` はログインユーザーでフィルタ |
| **ホスト/メンバー切り替え連動** | カスタムイベントで即時再取得 |

### 3.6 プロジェクト詳細でのオーナー編集

| 項目 | 実装 |
|------|------|
| **概要の編集** | 概要タブに編集ボタン、Markdown テキストエリア、保存・キャンセル |
| **アップデート投稿** | アップデートタブに投稿フォーム（タイトル任意・本文必須） |
| **アップデート編集・削除** | 各アップデートに編集・削除ボタン。編集はインライン、削除は確認ダイアログ |
| **API** | `updateProject`（overview）、`createProjectUpdate`、`updateProjectUpdate`、`deleteProjectUpdate` |
| **モック** | `projectOverviewOverrides`、`projectUpdatesStore`（セッション内で反映） |

### 3.7 認証方式の拡張（Email・Apple）

Google・GitHubに加え、**Email ログイン**と**Apple ログイン**を追加できる。

| 方式 | 概要 | モックでの扱い | 本番実装時の要点 |
|------|------|----------------|------------------|
| **Email** | **方針**: まず**マジックリンク方式**を採用。パスワード方式は将来拡張として保留。 | ログインボタン「Email」クリック → メールアドレス入力フォーム（モーダルまたは `/login/email`）→「リンクを送信」→ 送信完了表示。本番ではメール内リンクで検証 API 呼び出し → セッション確立。 | メール送信（SendGrid 等）、短期トークン発行・検証、GetOrCreateUserFromProvider("email", tokenId, email, name)。パスワードは将来オプションで password_hash を使用。 |
| **Apple Sign In** | OAuth 2.0 の一種。iOS/Safari ではネイティブ連携も可能。 | Google/GitHub と同様に「Apple」ボタンを追加し、`getAppleLoginUrl()` でリダイレクト先を返すモックで UX を検証。 | Apple Developer で Service ID 作成、Sign in with Apple JS またはリダイレクト。users に apple_id 等を保存。 |

※ 同一ユーザー判定は **email をキーに 1 アカウントにまとめる** 方針（`docs/idea.md` 寄付者 UX に記載）。

---

## 4. ホスト・プラットフォームプロジェクトの UX 設計

### 4.1 想定シナリオ

- 運営者（あなた）も一プロジェクトオーナーとしてアカウントを作り、寄付を募る
- あなたにのみホスト権限を持たせる
- サービスホストページに GIVErS プロジェクトの情報を載せる

### 4.2 ホストのアカウントコントロール権限

- ホストは**アカウントコントロール権限**を持つ
- **ユーザー一覧にアクセスできる**
- プロジェクトオーナーがシステムを悪用していると判断した場合、**利用停止**できる
- **停止解除**もできる
- 思想として「人の善性を信頼する」が基本だが、明らかな悪用に対する最終手段としてホストの裁量で対応する

### 4.3 アクセス経路（両方からアクセス可能）

| 経路 | 遷移先 |
|------|--------|
| ナビ「GIVErS への寄付」 | `/host`（専用ページ） |
| 専用ページ「GIVErS に寄付する」 | `/projects/mock-4`（寄付フォーム） |
| 専用ページ「プロジェクト詳細を見る」 | `/projects/mock-4` |
| 専用ページ「プロジェクト一覧でも見る」 | `/projects` |
| トップ「人気のプロジェクト」 | mock-4 にバッジ表示 → クリックで詳細 |
| プロジェクト一覧 | mock-4 にバッジ表示 → クリックで詳細 |
| プロジェクト詳細（mock-4）「サービスホストページへ」 | `/host` |

### 4.4 専用ページの体裁

`/host` はプロジェクト詳細（`/projects/mock-4`）と**同じ体裁**で表示する。`ProjectDetail` コンポーネントを共通利用し、以下のみ差し替え：

- **戻るリンク**: トップ（`/`）へ
- **「サービスホストページへ」リンク**: 非表示（既にホストページのため）

### 4.5 マイページ（メンバーページ）の仕様

| 項目 | 内容 |
|------|------|
| **対象** | ログイン済みユーザー（寄付者・プロジェクトオーナー共通） |
| **未ログイン時** | 「ログインすると、あなたのプロジェクトや寄付履歴が表示されます。」と表示 |

#### タブ構成

| タブ | 内容 |
|------|------|
| **寄付タブ** | 寄付履歴、定期寄付管理 |
| **プロジェクトタブ** | 自分がオーナーのプロジェクト一覧、新規作成・編集・ステータス変更 |

#### 寄付タブの詳細

| セクション | 表示内容 |
|------------|----------|
| **寄付履歴** | プロジェクト名（リンク）、金額、日時、メッセージをテーブル表示。日付降順。 |
| **定期寄付管理** | プロジェクト名（リンク）、金額/タイミング（月額・年額）、変更・一時休止/再開・削除ボタン。変更で金額・タイミングを編集。休止中は「休止中」表示。削除は確認ダイアログ後、一覧から非表示。 |

#### プロジェクトタブの詳細

| 機能 | 内容 |
|------|------|
| **新規作成** | `/projects/new` へのリンク |
| **編集** | 各プロジェクトの `/projects/[id]/edit` へのリンク |
| **ステータス変更** | ドロップダウンで active（公開中）/ frozen（凍結）/ deleted（削除済み）を切り替え。DB は論理ステータス管理。 |

#### アクセス経路

| 経路 | 遷移先 |
|------|--------|
| ナビ「マイページ」 | `/me` |
| 寄付タブ内のプロジェクト名 | `/projects/[id]` |
| プロジェクトタブの「新規プロジェクト」 | `/projects/new` |
| プロジェクトタブのプロジェクト名 | `/projects/[id]` |
| プロジェクトタブの「編集」 | `/projects/[id]/edit` |

### 4.6 プロジェクト詳細ページでのオーナー編集

| 項目 | 内容 |
|------|------|
| **対象** | プロジェクトオーナーが自分のプロジェクト詳細ページを閲覧している場合のみ |
| **概要の編集** | 概要タブに「概要を編集」ボタン。クリックで Markdown テキストエリア表示。保存・キャンセル。 |
| **アップデート投稿** | アップデートタブに投稿フォーム（タイトル任意・本文必須）。投稿後すぐに一覧に反映。 |
| **アップデート編集・削除** | 各アップデートに編集・削除ボタン。編集はインラインでタイトル・本文を変更。削除は確認ダイアログ後実行。 |
| **権限** | `getMe()` でログインユーザーを取得し、`project.owner_id === me.id` のときのみ編集UIを表示 |

---

## 5. 決済・Stripe Connect の検討内容

### 5.1 Stripe Connect 方針

| 項目 | 決定内容 |
|------|----------|
| **アカウントタイプ** | **Standard**（プロジェクトオーナーが自分の Stripe アカウントを OAuth で接続） |
| **料金体系** | 「Stripe が管理」を選択 → プラットフォーム側の Connect 追加コストはゼロ |
| **入金先** | プロジェクトオーナー自身の Stripe アカウントに直接入金 |

### 5.2 寄付フロー（Phase 4 以降）

- 寄付フォーム → Stripe Checkout に遷移
- 自前の決済完了ページは不要（成功/キャンセル用の戻り先のみ）
- 通貨選択は寄付フォームに含める（募集者が複数通貨を許可している場合のみ）
- 外国通貨の両替は Stripe が自動で換算（手数料約 2%）

### 5.3 募集者の設定オプション（idea.md より）

| 項目 | 設定内容 |
|------|----------|
| 金額 | 推奨額（¥500, ¥1,000 など）、任意額の許可 |
| 通貨 | JPY, USD, EUR など複数選択可 |
| 単発/サブスク | 単発のみ / サブスクのみ / 両方 |
| サブスク周期 | 月額 / 年額 |

---

## 6. コンポーネント構成

```
frontend/src/components/react/
├── ActivityFeed.tsx        # アクティビティフィード
├── AuthStatus.tsx         # ログイン状態
├── ConfirmDialog.tsx      # 確認ダイアログ（削除等）
├── MePage.tsx             # マイページ（寄付タブ・プロジェクトタブ）
├── NavAdminLink.tsx       # ユーザー管理リンク（ホスト時のみ表示）
├── DonateForm.tsx         # 寄付フォーム（単発/毎月）
├── FeaturedProjects.tsx   # 新着・人気プロジェクト
├── HealthStatus.tsx       # API ステータス
├── ProjectDetail.tsx      # プロジェクト詳細
├── ProjectList.tsx        # プロジェクト一覧
├── charts/
│   └── ProjectChart.tsx   # プロジェクトチャート
```

---

## 7. ページ構成

| パス | 内容 |
|------|------|
| `/` | トップ（ヒーロー、アクティビティ、新着/HOT、API ステータス） |
| `/host` | GIVErS への寄付 専用ページ |
| `/projects` | プロジェクト一覧 |
| `/projects/[id]` | プロジェクト詳細（寄付フォーム、チャート含む） |
| `/projects/new` | 新規プロジェクト作成 |
| `/me` | マイページ（寄付履歴・定期寄付・プロジェクト管理） |
| `/about` | About |
| `/en/*` | 英語版（上記と同構成） |

---

## 8. i18n キー

### 8.1 ホスト・プラットフォーム関連

| キー | 日本語 | 英語 |
|------|--------|------|
| `nav.host` | GIVErS への寄付 | Donate to GIVErS |
| `host.title` | GIVErS への寄付 | Donate to GIVErS |
| `host.donateCta` | GIVErS に寄付する | Donate to GIVErS |
| `host.viewProjectDetail` | プロジェクト詳細を見る | View project details |
| `host.viewInProjectList` | プロジェクト一覧でも見る | Also in project list |
| `host.signalTitle` | 運営状況 | Platform status |
| `platformProject.badge` | プラットフォームプロジェクト | Platform project |
| `platformProject.hostPageLink` | サービスホストページへ | Service host page |

### 8.2 マイページ関連

| キー | 日本語 | 英語 |
|------|--------|------|
| `nav.me` | マイページ | My Page |
| `me.title` | マイページ | My Page |
| `me.tabDonations` | 寄付 | Donations |
| `me.tabProjects` | プロジェクト | Projects |
| `me.donationHistory` | 寄付履歴 | Donation History |
| `me.recurringDonations` | 定期寄付管理 | Recurring Donations |
| `me.noDonations` | 寄付履歴はありません。 | No donations yet. |
| `me.noRecurring` | 定期寄付はありません。 | No recurring donations. |
| `me.cancelRecurring` | キャンセル | Cancel |
| `me.cancelled` | キャンセル済み | Cancelled |
| `me.projectName` | プロジェクト | Project |
| `me.amount` | 金額 | Amount |
| `me.date` | 日時 | Date |
| `me.message` | メッセージ | Message |
| `me.newProject` | 新規プロジェクト | New Project |
| `me.editProject` | 編集 | Edit |
| `me.status` | ステータス | Status |
| `me.statusActive` | 公開中 | Active |
| `me.statusFrozen` | 凍結 | Frozen |
| `me.statusDeleted` | 削除済み | Deleted |
| `me.noProjects` | プロジェクトはまだありません。 | No projects yet. |
| `me.loginPrompt` | ログインすると、あなたのプロジェクトや寄付履歴が表示されます。 | When logged in, your projects and donation history will be displayed. |

### 8.3 プロジェクト詳細（オーナー編集）

| キー | 日本語 | 英語 |
|------|--------|------|
| `projects.editOverview` | 概要を編集 | Edit overview |
| `projects.save` | 保存 | Save |
| `projects.cancel` | キャンセル | Cancel |
| `projects.postUpdate` | アップデートを投稿 | Post update |
| `projects.updateTitlePlaceholder` | タイトル（任意） | Title (optional) |
| `projects.updateBodyPlaceholder` | 本文を入力 | Enter body |
| `projects.editUpdate` | 編集 | Edit |
| `projects.deleteUpdate` | 削除 | Delete |
| `projects.deleteUpdateConfirm` | このアップデートを削除しますか？ | Delete this update? |

---

## 9. プロジェクトオーナーのミュート機能（仕様）

| 項目 | 内容 |
|------|------|
| **メッセージ送信** | 寄付時のみ。寄付フォームのメッセージ欄が唯一の手段 |
| **ミュート** | プロジェクトオーナーは他のユーザーをミュート・解除できる |
| **ミュート時の制限** | ミュートされたユーザーはそのプロジェクトに寄付できない |
| **スコープ** | ミュートはプロジェクト単位。他プロジェクトには影響しない |
| **複数プロジェクト** | プロジェクトオーナーは複数のプロジェクトを立ち上げて募集できる |
| **プロジェクトのライフサイクル** | 立ち上げ、凍結、削除ができる。DB は論理ステータス管理（active / frozen / deleted） |

※ 寄付をしながら悪態をつくユーザーへの対策として、オーナーが悪意のあるユーザーをミュートできる。

---

## 10. 今後の検討項目（モックで先行検証可能）

| 項目 | 内容 |
|------|------|
| ローディング・スケルトン | 白画面より「読み込み中」が伝わる UX |
| 関連プロジェクト | プロジェクト詳細に「このプロジェクトを応援している人はこちらも」 |
| ウォッチボタン | プロジェクト詳細に「ウォッチする」、マイページに一覧 |
| 匿名寄付→アカウント移行 | 「これまでの寄付をアカウントに引き継ぎますか？」フロー |
| 認証拡張 | Email ログイン（マジックリンク/パスワード）、Apple Sign In。モックでボタン配置・導線を検証可能（3.7 参照）。 |
| レスポンシブ強化 | モバイルでのハンバーガーメニュー、グリッド調整 |
| マイクロインタラクション | カードホバー、達成率バーアニメーション |

---

## 12. さらに検討すべき内容

ここまで（寄付者種別の定義、寄付履歴の全件保存、認証拡張 Email/Apple、UI モック・ダミー API）を踏まえ、**方針決定や設計の詰め**が必要な項目を整理する。

### 12.1 認証・アカウント

| 項目 | 検討内容 |
|------|----------|
| **同一ユーザー判定** | **方針決定済み**: email をキーに 1 アカウントにまとめる（Google / GitHub / Apple / Email で同じ email なら同一ユーザーとしてリンク）。→ `docs/idea.md` 寄付者 UX に記載。実装時は users に複数 provider（google_id, github_id, apple_id 等）を紐づけ、email で既存ユーザー検索してリンクする。 |
| **users テーブル拡張** | **方針決定済み**: 1 行で複数プロバイダを保持。`email`, `name`, `google_id`, `github_id`, `apple_id`, `password_hash`（いずれも NULL 可）。同一ユーザーは email で検索してリンク。→ `docs/phase2-plan.md` データモデル・`docs/implementation-plan.md` データモデルに記載。 |
| **Phase 2 設計の汎用化** | **方針決定済み**: UserRepository は `FindByProviderID(provider, id)` と `FindByEmail(email)`。AuthService は `GetOrCreateUserFromProvider(provider, providerUserID, email, name)` の 1 本。有効プロバイダは環境変数（GOOGLE_CLIENT_ID 等）の有無で切り替え。→ `docs/phase2-plan.md`「認証プロバイダ汎用化仕様」に記載。 |
| **Email ログインの UI** | **方針決定済み**: **マジックリンク方式**を採用。フロー: 「Email」ボタン → メールアドレス入力フォーム（モーダルまたは専用ページ）→「リンクを送信」→ 送信完了メッセージ → ユーザーがメール内リンクをクリック → 検証 API でセッション確立。初回は同一フローでアカウント自動作成。パスワード方式は将来拡張として保留。→ 3.7 表・本項に記載。 |
| **ログインボタン優先度・並び** | Google / GitHub / Apple / Email の 4 本立て時、並び順・モバイルでの折り返し・「主推奨」の見せ方。 |

### 12.2 寄付・トークン・移行

| 項目 | 検討内容 |
|------|----------|
| **donor 識別のスキーマ** | `donor_token_or_user_id` を 1 カラムで「token:xxx」「user:xxx」のように持つか、`donor_type`（token / user）と `donor_id` の 2 カラムにするか。検索・インデックス・移行処理のしやすさ。 |
| **トークン→アカウント移行の API** | 例: `POST /api/me/migrate-from-token`（Cookie のトークンを送る）で、トークンに紐づく寄付を現在ユーザーに移行する。エンドポイント・冪等性・「すでに移行済み」の扱いを定義する。 |
| **匿名寄付者の履歴の見せ方** | トークンのみの人は「マイページ」がない。寄付完了画面で「このブラウザの寄付履歴は Cookie で保持。アカウントを作ると引き継げる」旨をどこまで明示するか。 |
| **単発寄付時のトークン発行タイミング** | 寄付フォーム表示時か、Checkout 完了後か。Cookie の有効期限・SameSite 等の検討。 |

### 12.3 データ・分析・プライバシー

| 項目 | 検討内容 |
|------|----------|
| **寄付履歴の保存期間** | 永続保存か、一定期間後に匿名化・削除するか。データ分析利用と「必要最小限」のバランス。 |
| **データ分析の範囲** | 匿名集計のみか、ホスト向けダッシュボード（プロジェクト別・時間帯別など）をどこまで提供するか。 |
| **個人情報・削除依頼** | トークンに紐づく行動履歴の扱い。アカウント削除・利用停止時の寄付レコードの匿名化や削除ポリシー。GDPR 等を意識した方針の有無。 |

### 12.4 モックで先行して検証したいこと

| 項目 | 検討内容 |
|------|----------|
| **匿名寄付→アカウント移行のシナリオ** | 同一ブラウザで「トークン付きで単発寄付→ログイン→引き継ぎ確認」をモックで再現する手順と、必要なモック API（例: 移行確認ダイアログ用のフラグ）。 |
| **Email ボタン押下時のモック** | 現状は `url: '#'` のため何も起きない。「Email でログイン」クリックで簡易フォームや「準備中」モーダルを出すか。導線の検証に必要な最小 UI の検討。 |

### 12.5 ホスト・運用・決済

| 項目 | 検討内容 |
|------|----------|
| **利用停止ユーザーの決済** | ホストが利用停止したユーザーの定期寄付・Stripe サブスクをどう扱うか（停止と同時に解約するか、表示のみ停止するか）。 |
| **プロジェクト凍結・削除時の寄付** | 凍結・削除後も Stripe 上で新規寄付・サブスクを止めるか。受付停止のタイミングと API 側の制御。 |
| **新着・HOT のアルゴリズム** | トップの「新着」「HOT」を何で定義するか（登録日、直近寄付額、支援人数など）。モックデータで再現可能か。 |

### 12.6 その他

| 項目 | 検討内容 |
|------|----------|
| **自ホスト版の認証** | 公式は Google/GitHub 等を有効にし、自ホストでは環境変数で「Google のみ」「Email のみ」などプロバイダを切り替える仕様にするか。 |
| **公式/自ホストの明示** | idea.md の「公式の明示」「自ホスト版の自己申告」を、フッター・About・初期表示でどこまで実装するか（Phase 6 前提の優先度含む）。 |

---

## 11. 関連ドキュメント

- `docs/idea.md` - GIVErS の思想・全体設計
- `docs/ux-mock-phase-proposal.md` - UX モックフェーズの提案・優先度
- `docs/charts-plan.md` - チャート表示の実装プラン
- `docs/user-management-mock-plan.md` - ユーザー管理（ホスト・ミュート）のモック実装プラン
- `docs/conoha-deployment.md` - ConoHa サーバーでの運用設定
