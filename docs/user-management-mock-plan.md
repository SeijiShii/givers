# ユーザー管理 モック実装プラン

**目的**: ホストのアカウントコントロール（利用停止・解除）と、プロジェクトオーナーのミュート機能をモックで UX 検証する。

**前提**: サーバー実装は凍結。`PUBLIC_MOCK_MODE=true` でモック API を使用。

**最終更新**: 2025-02

---

## 1. 機能概要

### 1.1 ホストのユーザー管理

| 機能 | 内容 |
|------|------|
| ユーザー一覧 | 全ユーザーを閲覧できる |
| 利用停止 | 悪用と判断したユーザーを停止できる |
| 停止解除 | 停止したユーザーを解除できる |

### 1.2 プロジェクトオーナーのミュート管理

| 機能 | 内容 |
|------|------|
| ミュート | 悪意のあるユーザーをミュートできる |
| 解除 | ミュートを解除できる |
| スコープ | プロジェクト単位。他プロジェクトには影響しない |
| 制限 | ミュートされたユーザーはそのプロジェクトに寄付できない |

### 1.3 利用停止・凍結時のメッセージ表示（UX）

| 状況 | 方針 |
|------|------|
| **利用停止されたアカウント** | ログイン中のユーザーが利用停止されている場合、寄付・プロジェクト作成等のアクションを試みたときに、**状況を理解できる親切なメッセージ**を表示する。例：「このアカウントは利用停止されています。ご不明な点は運営までお問い合わせください。」API が 403 を返す場合も、フロントで理由が分かる文言を表示する。 |
| **凍結・削除されたプロジェクト** | 凍結または削除されたプロジェクトに寄付やその他のアクションを試みたときに、**状況を理解できる親切なメッセージ**を表示する。例：「このプロジェクトは現在、寄付の受付を停止しています。」「このプロジェクトは終了しています。」idea.md に記載。 |

### 1.4 開示用データの出力（第三者情報開示請求等への対応）

法的リスク対応のため、裁判所の命令・法執行機関の照会・訴訟等で**第三者への情報開示**を求められた場合に、運営者が提示しうる情報を**管理画面から UI で出力**できるようにする。詳細は `docs/legal-risk-considerations.md` 4. 第三者情報開示請求等への対応 を参照。

| 項目 | 内容 |
|------|------|
| **アクセス** | ホストのみ。ユーザー管理画面または専用の「開示用データ出力」画面から実行。 |
| **対象の指定** | **ユーザーID** または **プロジェクトID** を入力し、「開示用データを出力」を実行。 |
| **出力形式** | **JSON**（構造化データ。機械可読）。オプションで **PDF**（人間が読みやすい要約）。 |
| **出力内容（ユーザー指定時）** | 当該ユーザーのアカウント情報（ID, email, name, created_at, updated_at, status, role、認証プロバイダ紐づけ有無。パスワード・トークンは含めない）、当該ユーザーがオーナーのプロジェクト一覧、当該ユーザーの寄付履歴（寄付者として）・定期寄付一覧。メタデータ（出力日時、プラットフォーム名）。 |
| **出力内容（プロジェクト指定時）** | 当該プロジェクトの基本情報・オーナー情報・ステータス・費用・目標、当該プロジェクトへの寄付一覧（金額・日時・donor は匿名化方針に合わせて識別子または匿名化済み表記）。メタデータ（出力日時、プラットフォーム名）。 |
| **API** | `GET /api/admin/disclosure-export?type=user&id=:userId` または `?type=project&id=:projectId`。レスポンスは JSON。ホスト認証必須。 |
| **操作ログ** | 誰がいつどの対象（user_id または project_id）で出力したかを記録することを推奨（実装は別フェーズ可）。 |

---

## 2. モックデータ設計

### 2.1 ユーザー（拡張）

| フィールド | 型 | 説明 |
|------------|-----|------|
| id | string | ユーザーID |
| email | string | メールアドレス |
| name | string | 表示名 |
| status | 'active' \| 'suspended' | アカウント状態 |
| created_at | string | 登録日時 |
| project_count | number | オーナーのプロジェクト数（モック用） |
| last_donation_at | string \| null | 最終寄付日時（モック用） |

**データソース**: `frontend/src/data/mock-users.ts`（新規）

### 2.2 ミュート（プロジェクト単位）

| フィールド | 型 | 説明 |
|------------|-----|------|
| project_id | string | プロジェクトID |
| muted_user_id | string | ミュートされたユーザーID |
| muted_at | string | ミュート日時 |

**データソース**: `frontend/src/data/mock-mutes.ts`（新規）

### 2.3 モックシナリオ例

- **ユーザー**: 10〜15件（うち 1〜2件は suspended）
- **ミュート**: mock-1 で user-5 をミュート、mock-4 で user-3 をミュート など
- **ホストユーザー**: user-1（山田太郎）をホストとして扱う（環境変数または定数で指定）

---

## 3. API 設計（モック）

### 3.1 ホスト用

| メソッド | パス | 説明 |
|----------|------|------|
| GET | /api/admin/users | ユーザー一覧（ホストのみ） |
| POST | /api/admin/users/:id/suspend | 利用停止 |
| POST | /api/admin/users/:id/unsuspend | 停止解除 |
| GET | /api/admin/disclosure-export?type=user&id=:id | 開示用データ（ユーザー指定）。ホストのみ。JSON を返す。 |
| GET | /api/admin/disclosure-export?type=project&id=:id | 開示用データ（プロジェクト指定）。ホストのみ。JSON を返す。 |

### 3.2 プロジェクトオーナー用

| メソッド | パス | 説明 |
|----------|------|------|
| GET | /api/projects/:id/mutes | プロジェクトのミュート一覧 |
| POST | /api/projects/:id/mutes | ユーザーをミュート |
| DELETE | /api/projects/:id/mutes/:userId | ミュート解除 |
| GET | /api/me/is-muted?project=:id | 自分がミュートされているか（寄付フォーム用） |

### 3.3 認証・権限（モック）

- `getMe()` の戻り値に `role: 'host' | 'project_owner' | 'donor'` を追加
- ホストページ・管理画面は `role === 'host'` のときのみ表示
- プロジェクトのミュート管理は `owner_id === me.id` のときのみ表示

---

## 4. ページ・UI 設計

### 4.1 ホスト: ユーザー管理ページ

| 項目 | 内容 |
|------|------|
| **パス** | `/admin/users` または `/host/users` |
| **アクセス** | ホストのみ。ナビに「ユーザー管理」を追加（ホスト時のみ表示） |
| **構成** | ユーザー一覧テーブル、検索、ステータス表示、利用停止/解除ボタン |

**UI 要素**:
- テーブル: 名前、メール、ステータス、プロジェクト数、最終活動、操作
- ステータス: 通常 / 停止中
- 操作: 「利用停止」「停止解除」ボタン、「開示用データを出力」ボタン（ユーザー行ごと、または一括でユーザーID入力）
- 確認ダイアログ: 停止・解除時に確認。開示用出力時は「出力したデータは法的開示請求等に備えたものです。取り扱いに注意してください。」等の注意表示を表示してからダウンロード
- **開示用データ出力**: ユーザー管理画面に「開示用データを出力」ブロックを設け、ユーザーID または プロジェクトID を入力して JSON をダウンロード。必要に応じて別ページ `/admin/disclosure-export` でも同一機能を提供

### 4.2 プロジェクトオーナー: ミュート管理

| 項目 | 内容 |
|------|------|
| **場所** | プロジェクト編集ページ内、またはマイページのプロジェクト詳細 |
| **パス案** | `/projects/[id]/mutes` または `/me/projects/[id]/mutes` |
| **構成** | ミュート一覧、ミュート追加（寄付者から選択）、解除ボタン |

**UI 要素**:
- ミュート一覧: ユーザー名、ミュート日時、解除ボタン
- ミュート追加: 最近の寄付者一覧から「ミュート」ボタン
- 空状態: 「ミュートしているユーザーはいません」

### 4.3 寄付フォーム: ミュート時の制限

| 項目 | 内容 |
|------|------|
| **表示** | ミュートされている場合、寄付フォームの代わりにメッセージ表示 |
| **文言** | 「このプロジェクトには寄付できません。プロジェクトオーナーにより制限されています。」 |

---

## 5. 実装フェーズ

### Phase 1: モックデータ・API 基盤（0.5〜1日）

| タスク | 内容 |
|--------|------|
| mock-users.ts | ユーザー一覧データ（10〜15件、1〜2件 suspended） |
| mock-mutes.ts | ミュートデータ（プロジェクト単位） |
| api.ts 拡張 | User 型に status 追加、getUsers, suspendUser, unsuspendUser |
| api.ts 拡張 | getMutes, addMute, removeMute, checkIsMuted |
| mock-api.ts | 上記 API のモック実装 |
| getMe 拡張 | role, ホスト判定用のモック（環境変数でホストユーザーID指定） |

### Phase 2: ホスト ユーザー管理 UI（1日）

| タスク | 内容 |
|--------|------|
| /admin/users ページ | ユーザー一覧テーブル |
| UserList コンポーネント | テーブル、ステータス表示、操作ボタン |
| 権限チェック | ホストでない場合リダイレクトまたは 403 表示 |
| ナビ | ホスト時のみ「ユーザー管理」リンク表示 |
| 確認ダイアログ | 利用停止・解除時の確認 |

### Phase 3: プロジェクトオーナー ミュート管理 UI（1日）

| タスク | 内容 |
|--------|------|
| ミュート管理ページ | /projects/[id]/mutes または マイページ内 |
| MuteList コンポーネント | ミュート一覧、解除ボタン |
| ミュート追加 | 最近の寄付者からミュート追加 UI |
| 権限チェック | オーナーのみアクセス可能 |
| 導線 | プロジェクト詳細・編集画面からミュート管理へリンク |

### Phase 4: 寄付フォーム ミュート制限（0.5日）

| タスク | 内容 |
|--------|------|
| DonateForm 拡張 | ミュートチェック、制限時はフォーム非表示 |
| メッセージ表示 | ミュート時の説明文 |
| getMe モック | ログイン状態の切り替え（ミュート検証用） |

### Phase 5: 細部調整・i18n（0.5日）

| タスク | 内容 |
|--------|------|
| i18n | ユーザー管理、ミュート関連の翻訳キー |
| ローディング | 一覧取得中のスケルトン |
| エラー表示 | API エラー時のメッセージ |

---

## 6. ファイル構成（追加）

```
frontend/src/
├── data/
│   ├── mock-users.ts        # ユーザー一覧（新規）
│   └── mock-mutes.ts        # ミュートデータ（新規）
├── pages/
│   ├── admin/
│   │   └── users.astro      # ホスト ユーザー管理（新規）
│   └── projects/
│       └── [id]/
│           └── mutes.astro  # ミュート管理（新規）
├── components/react/
│   ├── UserList.tsx         # ユーザー一覧（ホスト用）（新規）
│   ├── MuteList.tsx         # ミュート一覧（オーナー用）（新規）
│   └── DonateForm.tsx       # ミュート制限を追加（既存）
└── lib/
    ├── api.ts               # ユーザー管理・ミュート API 追加
    └── mock-api.ts          # モック実装追加
```

---

## 7. モック時のログイン切り替え（検証用）

| 方式 | 内容 |
|------|------|
| **環境変数** | `PUBLIC_MOCK_AS_USER=user-1` で getMe の戻り値を切り替え |
| **クエリパラメータ** | `?mock_as=host` でホストとしてログイン（開発時のみ） |
| **ローカルストレージ** | モック時に `mock_user_id` を保存し、getMe で参照 |

**推奨**: 環境変数 `PUBLIC_MOCK_AS_USER` で user-1（ホスト）固定。必要に応じてクエリで上書き。

---

## 8. 依存関係

| 前提 | 状態 |
|------|------|
| ログイン状態のモック | getMe が null を返す現状 → 拡張でログイン済みをシミュレート |
| マイページ | `/me` は存在。プロジェクト一覧への導線を追加 |
| プロジェクト編集 | `/projects/[id]/edit` は存在。ミュート管理へのリンクを追加 |

---

## 9. 成果物チェックリスト

- [ ] mock-users.ts
- [ ] mock-mutes.ts
- [ ] getUsers, suspendUser, unsuspendUser（API + モック）
- [ ] getMutes, addMute, removeMute, checkIsMuted（API + モック）
- [ ] getMe に role 追加、ホスト判定
- [ ] /admin/users ページ
- [ ] UserList コンポーネント
- [ ] **開示用データ出力**: getDisclosureExport(userId) / getDisclosureExport(projectId)（API + モック）、管理画面 UI（ユーザーID/プロジェクトID 入力→JSON ダウンロード）
- [ ] /projects/[id]/mutes ページ
- [ ] MuteList コンポーネント
- [ ] DonateForm ミュート制限
- [ ] i18n キー
- [ ] ナビ・導線の更新

---

## 10. 関連ドキュメント

- `docs/idea.md` - プロジェクトオーナーのミュート機能
- `docs/mock-implementation-status.md` - ホストのアカウントコントロール権限、ミュート仕様
- `docs/legal-risk-considerations.md` - 第三者情報開示請求等への対応（開示すべき情報の定義、管理画面からの出力方針）
